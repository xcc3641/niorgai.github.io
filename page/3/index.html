<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>



  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  


<link rel="stylesheet" type="text/css" href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" />

<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>


    <meta name="description" content="Android | jianqiu's blog" />



  <meta name="keywords" content="Hexo,next" />





  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />


<meta name="description" content="Android | jianqiu&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Jianqiu's blog">
<meta property="og:url" content="http://niorgai.github.io/page/3/index.html">
<meta property="og:site_name" content="Jianqiu's blog">
<meta property="og:description" content="Android | jianqiu&apos;s blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jianqiu's blog">
<meta name="twitter:description" content="Android | jianqiu&apos;s blog">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>



  <title> Jianqiu's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Jianqiu's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Learn More</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 
  <section id="posts" class="posts-expand">
    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/03/19/Android-Studio开发遇到的问题/" itemprop="url">
                  Android Studio开发遇到的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-19T10:14:47+08:00" content="2015 Mar 19">
              2015 Mar 19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android开发工具/" itemprop="url" rel="index">
                    <span itemprop="name">Android开发工具</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/19/Android-Studio开发遇到的问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/19/Android-Studio开发遇到的问题/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <ol>
<li><p>Android studio卡顿优化</p>
<p> 除了机器配置之外,也可以给Android Studio分配更多内存.<br> 打开Android Studio的安装目录,Mac下进入bin目录,打开studio.vmoptions文件,<br> 修改以下配置</p>
<ol>
<li>-Xms:JVM堆内存,默认是物理内存的1/64.</li>
<li>-Xmx:JVM最大内存,默认是物理内存的1/4.</li>
<li>-XX:MaxPermSize:最大非堆内存,默认是物理内存的1/4.</li>
<li><p>-XX:ReservedCodeCacheSize:缓存大小.</p>
<p>把这些调大就好了~</p>
</li>
</ol>
</li>
</ol>
<ol>
<li><p>Gradle没有自动下载dependence包。</p>
<p> 解决方法：</p>
<ol>
<li>检查gradle环境。<ol>
<li>在工程目录下依次运行<code>gradle clean</code> , <code>gradle assemble</code></li>
</ol>
</li>
</ol>
</li>
<li><p><code>Executor Singleton not started</code></p>
<p> 升级一下gradle到最新版本,然后在project的build.gradle中修改gradle版本即可.</p>
</li>
<li><p>java <code>finished with non-zero exit value 2</code></p>
<p> 这是libs里面有包重复了,找出来删掉就好了</p>
</li>
<li><p>adb连接不到手机</p>
<p> 以魅族mx4为例，直接连接手机的话其实是识别不到的，adb连接需要添加机器的Vender ID。</p>
<ul>
<li><p>连接电脑，打开终端，输入</p>
<pre><code><span class="title">system_profiler</span> SPUSBDataType
</code></pre></li>
<li><p>找到手机(mx4)，复制Vender ID（我的是0x2a45）,注意只复制内容，然后进入adb_usb.ini文件。</p>
<pre><code>sudo vim ~<span class="regexp">/.android/adb</span>_usb.ini
</code></pre></li>
<li><p>将Vender ID直接复制在下面就好。然后依次输入</p>
<pre><code>adb <span class="operator"><span class="keyword">kill</span>-<span class="keyword">server</span>    
adb <span class="keyword">start</span>-<span class="keyword">server</span></span>
</code></pre><p><strong>注意adb_usb.ini这个文件不能有错误的行，或者vim打开产生的缓存文件没有删除，这样会导致无法运行adb</strong></p>
<p>顺便说一下环境变量的配置</p>
<p>首先进入.bashrc(使用bash的话是~/.bashrc,使用zsh的话是~/.zshrc)文件：</p>
<p>  vim ~/.bashrc</p>
<p>然后添加格式为：</p>
<p>  export PATH=”/Users/qiu/Documents/adt-bundle-mac-x86_64-20140702/sdk/tools:$PATH”</p>
<p>这样环境变量便是append进去了，不会覆盖PATH。<br>最后记得更新一下环境变量：</p>
<p>  source ~/.bashrc</p>
</li>
</ul>
</li>
</ol>
<ol>
<li><p>工程不在根目录下，比如在Test工程下又添加了Test1工程，就像这样:<img src="http://7sbqys.com1.z0.glb.clouddn.com/intelTest.jpg" alt=""></p>
<p> 然后因为找不到AndroidManifest.xml文件导致无法运行。</p>
<p> <strong>解决方法如下：</strong></p>
<ul>
<li>File-&gt;Project Structure</li>
<li>在左边点击Facets</li>
<li>找到你的项目，没有就添加一个</li>
<li>把Structure里面的路径全部替换为当前实际工程的项目。</li>
<li>顺利运行。</li>
</ul>
</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/03/14/ScrollView中放置ListView/" itemprop="url">
                  ScrollView中放置ListView
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-14T00:17:40+08:00" content="2015 Mar 14">
              2015 Mar 14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android开发经验/" itemprop="url" rel="index">
                    <span itemprop="name">Android开发经验</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/14/ScrollView中放置ListView/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/14/ScrollView中放置ListView/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>最近有个需求是需要在ScrollView中放置一个ListView，如果不做处理的话，直接放置控件会导致：</p>
<ol>
<li>ListView的高度设置为wrap_content时，每个item的高度无法控制，可能导致item高度为0而不显示。</li>
<li>ListView的高度设置为wrap_content时，疯狂调用getView方法导致卡顿。</li>
<li>ListView的高度设置了合适的高度后，ListView无法滑动。</li>
</ol>
<p>其对应的解决方法：</p>
<ol>
<li><p>在ListView调用了<code>setAdapter</code>或者<code>notifyDataChange</code>后，使用该方法重新设置ListView的高度。</p>
<pre><code>public static void setListViewHeightBasedOnChildren<span class="params">(ListView listView)</span> {
    ListAdapter listAdapter = listView.getAdapter<span class="params">()</span>;
    <span class="keyword">if</span> <span class="params">(listAdapter == null)</span>
        return;

    int desiredWidth = View.MeasureSpec.makeMeasureSpec<span class="params">(listView.getWidth<span class="params">()</span>, View.MeasureSpec.UNSPECIFIED)</span>;
    int totalHeight = <span class="number">0</span>;
    View view = null;
    <span class="keyword">for</span> <span class="params">(int i = <span class="number">0</span>; i &lt; listAdapter.getCount<span class="params">()</span>; i++)</span> {
        <span class="comment">//获取每个item的view</span>
        view = listAdapter.getView<span class="params">(i, view, listView)</span>;
        <span class="keyword">if</span> <span class="params">(i == <span class="number">0</span>)</span>
            view.setLayoutParams<span class="params">(new AbsListView.LayoutParams<span class="params">(desiredWidth, AbsListView.LayoutParams.WRAP_CONTENT)</span>)</span>;

        view.measure<span class="params">(desiredWidth, View.MeasureSpec.UNSPECIFIED)</span>;
        <span class="comment">//计算总高度</span>
        totalHeight += view.getMeasuredHeight<span class="params">()</span>;
    }
    ViewGroup.LayoutParams params = listView.getLayoutParams<span class="params">()</span>;
    <span class="comment">//加上divider的高度</span>
    params.height = totalHeight + <span class="params">(listView.getDividerHeight<span class="params">()</span> * <span class="params">(listAdapter.getCount<span class="params">()</span> - <span class="number">1</span>)</span>)</span>;
    listView.setLayoutParams<span class="params">(params)</span>;
    listView.requestLayout<span class="params">()</span>;
}
</code></pre><p> 该方法原理就是通过adapter的getView方法返回item的view，计算每个item的高度height乘以item的个数，最后加上divider的高度。(如果知道每个item的高度，可以直接获取adapter的count乘以高度即可，省区调用getView方法的时间)</p>
<pre><code>使用该方法需要注意：
<span class="number">1</span>. item的根布局是必须是LinearLayout等重写了<span class="escape">`o</span>nMeasure<span class="escape">`方</span>法的layout，因为获取高度时用到了<span class="escape">`v</span>iew.getMeasuredHeight()<span class="escape">`方</span>法.
<span class="number">2</span>. 该方法会在Adapter的getView方法前被调用。
</code></pre></li>
<li><p>在ListView外部放置一层单独的FrameLayout(性能最高)，设置Layout的高度为wrap_content,然后设置ListView的高度为fill_parent,最后在<code>setAdapter</code>或<code>notifyDataChange</code>后修改<code>setListViewHeightBasedOnChildren</code>方法，通过该方法返回带有正确高度的LinearLayout.LayoutParams(你没有看错，用LinearLayout.LayoutParams来设置FrameLayout)，以此来设置FrameLayout的高度。这样不会疯狂调用getView方法了。</p>
</li>
<li><p>在onTouch事件中取消父布局的touch劫持。</p>
<pre><code>listView.setOnTouchListener(<span class="keyword">new</span> OnTouchListener() {
    <span class="annotation">@Override</span>
    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">onTouch</span><span class="params">(View v, MotionEvent event)</span> </span>{
        v.getParent().requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);
        <span class="keyword">return</span> <span class="keyword">false</span>;
    }
});
</code></pre></li>
</ol>
<hr>
<p>如果使用了<a href="https://github.com/chrisbanes/Android-PullToRefresh" target="_blank" rel="external">Github开源项目-PullToRefreshListView</a>，它有一个headView和一个BottomView，所以它计算高度的方法会不同：</p>
<pre><code>public static void setListViewHeightBasedOnChildren<span class="params">(PullToRefreshListView listView)</span> {
    ListAdapter listAdapter = listView.getRefreshableView<span class="params">()</span>.getAdapter<span class="params">()</span>;
    <span class="keyword">if</span> <span class="params">(listAdapter == null)</span>
        return;

    int totalHeight = <span class="number">0</span>;
    View view = null;
    <span class="comment">//去掉头尾两个view</span>
    <span class="keyword">for</span> <span class="params">(int i = <span class="number">1</span>; i &lt; listAdapter.getCount<span class="params">()</span>-<span class="number">1</span>; i++)</span> {
        view = listAdapter.getView<span class="params">(i, view, listView)</span>;
        totalHeight += view.getLayoutParams<span class="params">()</span>.height;
    }
    ViewGroup.LayoutParams params = listView.getLayoutParams<span class="params">()</span>;
    params.height = totalHeight + <span class="params">(listView.getRefreshableView<span class="params">()</span>.getDividerHeight<span class="params">()</span> * <span class="params">(listAdapter.getCount<span class="params">()</span> - <span class="number">1</span>)</span>)</span>;
    listView.setLayoutParams<span class="params">(params)</span>;
    listView.requestLayout<span class="params">()</span>;
}
</code></pre><p>这里使用的是LayoutParams的height作为item的高度，所以在adapter的getView方法中，应该这样初始化：</p>
<pre><code><span class="keyword">public</span> <span class="function">View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>{
    convertView = inflater.inflate(R.layout.parenting_listview_item,parent,<span class="keyword">false</span>);
}
</code></pre>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/03/11/Android复用Layout/" itemprop="url">
                  Android复用Layout
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-11T22:07:12+08:00" content="2015 Mar 11">
              2015 Mar 11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android开发经验/" itemprop="url" rel="index">
                    <span itemprop="name">Android开发经验</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/11/Android复用Layout/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/11/Android复用Layout/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="&lt;include&gt;标签复用布局"><code>&lt;include&gt;</code>标签复用布局</h2><p>Android布局中经常可以发现能够重用的layout，如果每次都复制粘贴，第一是不方便，第二是可维护性不高，改动一个地方要改好几处，所以最直接的方法是复用layout。</p>
<p>如果原布局为：</p>
<pre><code><span class="tag">&lt;LinearLayout..&gt;</span>
    <span class="tag">&lt;LinearLayout..&gt;</span>
        <span class="tag">&lt;TextView..&gt;</span>
        <span class="tag">&lt;TextView..&gt;</span>
    <span class="tag">&lt;/LinearLayout&gt;</span>
    <span class="tag">&lt;LinearLayout..&gt;</span>
        <span class="tag">&lt;TextView..&gt;</span>
        <span class="tag">&lt;TextView..&gt;</span>
    <span class="tag">&lt;/LinearLayout&gt;</span>
<span class="tag">&lt;/LinearLayout&gt;</span>
</code></pre><p>那么可以抽取出复用布局reuse.xml：</p>
<pre><code><span class="tag">&lt;LinearLayout..&gt;</span>
    <span class="tag">&lt;TextView..&gt;</span>
    <span class="tag">&lt;TextView..&gt;</span>
<span class="tag">&lt;/LinearLayout&gt;</span>
</code></pre><p>复用时使用<code>&lt;layout&gt;</code>标签，设置<code>layout=&quot;@layout/layoutId&quot;</code>即可。</p>
<pre><code>&lt;include
    android:<span class="variable">layout_width=</span><span class="string">"fill_parent"</span>
    android:<span class="variable">layout_height=</span><span class="string">"0dp"</span>
    android:<span class="variable">layout_weight=</span><span class="string">"1"</span>
    <span class="variable">layout=</span><span class="string">"@layout/reuse.xml"</span>/&gt;
</code></pre><p><strong>注意如果需要设置width或height一定要两个一起设置才会生效</strong></p>
<p>如果希望减少reuse.xml中的LinearLayout嵌套(即在include时去掉根布局)，可以使用<code>&lt;merge&gt;</code>标签，即：</p>
<pre><code><span class="tag">&lt;Merge..&gt;</span>
    <span class="tag">&lt;TextView..&gt;</span>
    <span class="tag">&lt;TextView..&gt;</span>
<span class="tag">&lt;/Merge..&gt;</span>
</code></pre><hr>
<h4 id="抽取通用layout作为View">抽取通用layout作为View</h4><p>可以新建一个ReuseView</p>
<pre><code><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReuseView</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span></span>{

    <span class="function"><span class="keyword">public</span> <span class="title">MainPageInterface</span><span class="params">(Context context)</span> </span>{
        <span class="keyword">this</span>(context, <span class="keyword">null</span>);
    }

    <span class="function"><span class="keyword">public</span> <span class="title">MainPageInterface</span><span class="params">(Context context, AttributeSet attrs)</span> </span>{
        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);
    }

    <span class="function"><span class="keyword">public</span> <span class="title">MainPageInterface</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>{
        <span class="keyword">super</span>(context, attrs, defStyleAttr);
        init();
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>{
        inflate(getContext(), R.layout.reuse, ReuseView.<span class="keyword">this</span>);
    }
}
</code></pre><p>这样主布局便变成</p>
<pre><code><span class="tag">&lt;LinearLayout..&gt;</span>
    <span class="tag">&lt;ReuseView ../&gt;</span>
<span class="tag">&lt;/LinearLayout&gt;</span>
</code></pre><p>这样的好处便是可以在View中实现功能，模块分离方便业务调整。</p>
<p>LayoutInflater的inflate方法原型为：<code>View inflate (Context context, int resource, ViewGroup root)</code></p>
<p>注意：</p>
<ol>
<li>inflate方法返回的view的默认layoutParams为null。</li>
<li>返回值为The root View of the inflated hierarchy。</li>
<li>如果设置了第二个参数root <ol>
<li>attachToRoot为false，则只会返回设置了LayoutParams的view的root。</li>
<li>attachToRoot为true，则会返回将该view作为root返回。</li>
</ol>
</li>
<li>这样当R.layout.reuse为<merge>时,会少掉一层layout.</merge></li>
</ol>
<hr>
<p>惰性布局ViewStub</p>
<p>ViewStub用于显示本来不需要显示，只有特殊情况下才会显示的布局。虽然inflate一个布局的内存耗费较大，ViewStub会相对少一点。</p>
<pre><code>&lt;ViewStub
    android:<span class="variable">id=</span><span class="string">"@+id/stub_import"</span>
    android:<span class="variable">inflatedId=</span><span class="string">"@+id/panel_import"</span>
    android:<span class="variable">layout=</span><span class="string">"@layout/progress_overlay"</span>
    android:<span class="variable">layout_width=</span><span class="string">"fill_parent"</span>
    android:<span class="variable">layout_height=</span><span class="string">"wrap_content"</span>/&gt;
</code></pre><p>使用时设置visible或者inflate布局。</p>
<pre><code><span class="params">(<span class="params">(ViewStub)</span> findViewById<span class="params">(R.id.stub_import)</span>)</span>.setVisibility<span class="params">(View.VISIBLE)</span>;
<span class="comment">// or</span>
View importPanel = <span class="params">(<span class="params">(ViewStub)</span> findViewById<span class="params">(R.id.stub_import)</span>)</span>.inflate<span class="params">()</span>;
</code></pre><p>一旦ViewStub被显示或inflate，ViewStub将不再属于该布局，会被其inflate的layout取代。此时可以通过inflatedId去寻找该View。</p>
<p><strong>注意viewStub不支持</strong><code>&lt;merge&gt;</code><strong>标签</strong></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/03/03/Android内存泄漏/" itemprop="url">
                  Android内存泄漏
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-03T16:11:13+08:00" content="2015 Mar 3">
              2015 Mar 3
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android开发经验/" itemprop="url" rel="index">
                    <span itemprop="name">Android开发经验</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/03/Android内存泄漏/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/03/Android内存泄漏/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>以下内容提取于<a href="http://blog.csdn.net/gemmem/article/details/8920039" target="_blank" rel="external">Android进程的内存管理分析</a>及<a href="http://blog.csdn.net/gemmem/article/details/13017999" target="_blank" rel="external">Android内存泄漏分析及调试</a>.</p>
<p>Android中的内存分为：</p>
<ol>
<li>native进程：采用C/C++实现，不包含dalvik实例的进程。</li>
<li>java进程：Android中运行于dalvik虚拟机之上的进程。每一个java进程都是存在于一个native进程中。</li>
</ol>
<p>内存空间是一定的，所以在对象无用时就要回收一些对象来留出空间。当Java Garbage Collection开始运行时，它会从他了解还存活的对象作为内存遍历的根节点(GC Root)，遍历heap内存空间，没有直接或间接引用到GC Root的对象便会被回收。</p>
<p>而Android内存泄漏便是指进程中的对象，虽然没有使用价值了，但它仍然有直接或间接的引用到GC Root，那么该对象便不会被GC回收，导致内存持续被占用，使可用内存变小。</p>
<h2 id="常见的内存泄漏">常见的内存泄漏</h2><ol>
<li>查询数据库没有关闭Cursor。</li>
<li>使用BaseAdapter作为适配器时没有复用convertView。可以参考<a href="http://niorgai.github.io/2014/12/13/ListView%E4%B8%8EBaseAdapter%E4%BC%98%E5%8C%96/">ListView与BaseAdapter优化</a>.</li>
<li>bitmap没有回收，可以参考<a href="http://niorgai.github.io/2015/02/27/Bitmap%E7%9B%B8%E5%85%B3-%E7%AE%A1%E7%90%86Bitmap%E5%86%85%E5%AD%98/">Bitmap相关:管理Bitmap内存</a>.</li>
<li>注册对象后没有反注册，比如Broadcast Receiver等。</li>
<li>handler问题，如果handler是非静态的，会导致Activity或者Service不被回收，所以应当注册为静态内部类，同时在onDestroy时停止线程:<code>mThread.getLooper().quit();</code></li>
<li>Activity被静态引用，特别是缓存bitmap时，解决方法可以考虑使用Application的context代替Activity的context。</li>
<li><p>View在callback中被引用,可能回调还没有结束,但是view处于引用状态,无法回收</p>
<pre><code><span class="tag">public</span> <span class="tag">void</span> <span class="tag">leak</span>(final View view) {
    <span class="tag">api</span><span class="class">.callback</span>(new <span class="function">callBack</span>() {
        <span class="tag">onCallBack</span>() {
            ...
        }
    )
}
</code></pre></li>
<li>WebView的泄露问题:在魅族上面发现webView打开再关闭就会内存泄露..目前使用的解决方法是在webview外面嵌套一层layout作为container.在Activity的<code>onDestroy</code>中调用<code>container.removeAllViews()</code>方法.</li>
</ol>
<h2 id="检测内存泄露的方法">检测内存泄露的方法</h2><ol>
<li>Android Studio自带的Memory Monitor,手动触发GC可以看得比较直观</li>
<li>MAT<a href="http://androidperformance.com/2015/04/11/AndroidMemory-Usage-Of-MAT.html" target="_blank" rel="external">这篇文章</a>分析得比较透彻</li>
<li><a href="https://github.com/square/leakcanary" target="_blank" rel="external">Leakcanary</a>,检测一些容易忽略的内存泄露很好用.</li>
<li><code>adb shell dumpsys meminfo [包名]</code>可以看到内存使用情况.</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/03/02/Activity生命周期/" itemprop="url">
                  Activity生命周期
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-03-02T01:27:23+08:00" content="2015 Mar 2">
              2015 Mar 2
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android基础知识/" itemprop="url" rel="index">
                    <span itemprop="name">Android基础知识</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/03/02/Activity生命周期/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/03/02/Activity生命周期/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>Activity是很熟悉的东西，但是它的生命周期一直掌握的不够完全，所以就其方法和功能介绍一下：</p>
<p>对于Activity来说,本质上就是以下四种状态:</p>
<ol>
<li>Activity处于前台,此时它保持活跃的状态.</li>
<li>Activity失去焦点但任然可见(即被透明的或不是全屏的Activity挡住焦点),此时它会暂停(pause),暂停了的Activity任然是alive,它会维护住它的全部变量和状态,但可以在系统内存不足时被kill掉.</li>
<li>Activity完全被其他Activity挡住,那么他会停止(stop),它任然会维护住它的全部变量和状态,但它会更容易在系统内存不足时被kill掉</li>
<li>如果Activity被暂停或停止了,系统可以随时kill掉这个Activity或者直接kill整个进程.当它重新出现时,所有的状态必须重新创建.</li>
</ol>
<p>同时看一下官方给的一个说明图：<br><img src="http://7sbqys.com1.z0.glb.clouddn.com/activity_lifecycle.png" alt=""></p>
<p>这个图是给了一些基本的方法，下面再逐个说一下。</p>
<hr>
<p>启动部分：</p>
<ol>
<li><p><strong>onCreate(Bundle savedInstanceState)</strong></p>
<p> 在这里进行常见的初始化操作，比如绑定UI，初始化控件等。savedInstanceState参数存储了一些在<code>onSaveInstanceState(Bundle)</code>存储的数据，如果没有设置则为null。</p>
</li>
<li><p><strong>onRestart()</strong></p>
<p> 用户重新导航至该Activity时调用。</p>
</li>
<li><p><strong>onStart()</strong></p>
<p> 在<code>onCreate(Bundle savedInstanceState)</code>或<code>onRestart()</code>后调用。</p>
</li>
<li><p><strong>onRestoreInstanceState (Bundle savedInstanceState)</strong></p>
<p> 在<code>onStart()</code>和<code>onPostCreate (Bundle savedInstanceState)</code>之间调用，用于恢复在<code>onSaveInstanceState(Bundle)</code>中存储的数据。</p>
</li>
<li><p><strong>onPostCreate (Bundle savedInstanceState)</strong></p>
<p> 在Activity启动完成后调用，但通常不声明这个函数，它用于系统类的初始化。</p>
</li>
<li><p><strong>onResume ()</strong></p>
<p> 准备与用户进行交互，但这不是最佳的方式去判断当前界面是否对用户可用，但像键盘等系统控件弹出时也会影响焦点，所以最佳方式是使用<a href="http://developer.android.com/intl/zh-cn/reference/android/app/Activity.html#onWindowFocusChanged(boolean" target="_blank" rel="external"><code>onWindowFocusChanged (boolean hasFocus)</code></a>)来判断当前界面是否获得了焦点。</p>
</li>
<li><p><strong>onPostResume ()</strong></p>
<p> 当Activity resume完成后调用，但通常不声明这个函数，它用于系统类的初始化。</p>
</li>
</ol>
<hr>
<p>结束部分：</p>
<ol>
<li><p><strong>onPause ()</strong></p>
<p> 当Activity失去焦点但不被kill的时候，onPause()会被调用。只有onPause结束，新Activity的onCreate方法才会开始。</p>
</li>
<li><p><strong>onSaveInstanceState (Bundle outState)</strong></p>
<p> 本意是用于存储Activity数据，因为该方法不在Activity的生命周期内,所以谷歌不建议使用该方法存储数据,对用户的持久化数据处理应该放在onPause中.该数据可以通过<code>onCreate(Bundle)</code>或<code>onRestoreInstanceState (Bundle savedInstanceState)</code>恢复，该方法会在<code>onStop()</code>之前调用，但不一定会在<code>onPause</code>方法前调用。</p>
</li>
<li><p><strong>onStop ()</strong></p>
<p> 当Activity对用户已经不可见时调用，但当系统内存较低时，Activity可能在<code>onPause()</code>后没有足够内存继续运行而导致<code>onStop()</code>不被调用。</p>
</li>
<li><p><strong>onDestroy ()</strong></p>
<p> 在Activity销毁前执行最后工作，主要执行释放内存相关操作，不能在该方法内保存数据。</p>
</li>
</ol>
<hr>
<ol>
<li>整个生命周期从onCreate到onDestroy,所以对于一些全局的变量,需要在onCreate初始化,在onDestroy中销毁,例如handler.</li>
<li>可见的生命周期是从onStart到onStop,在这两个方法期间可以维护一些需要改变Activity展示的数据,比如BroadcastReceiver的注册和销毁.</li>
<li>前台的生命周期是onResume到onPause,此时用户可以与Activity交互.</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>


 </div>

        

        
      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Jianqiu" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Jianqiu</p>
        </div>
        <p class="site-description motion-element" itemprop="description">Android | jianqiu's blog</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">28</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">31</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/niorgai" target="_blank">
                  <i class="fa fa-github"></i> github
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jianqiu</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"niorgai"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    

    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.3"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.3"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.3" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.3"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }

      motionIntegrator.bootstrap();
    });
  </script>

  
  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
